# Исправления в мастер-карте стратегического развития

## Проблема
Проекты в мастер-карте не удалялись автоматически при удалении объектов строительства.

## Внесенные изменения

### 1. Добавлено каскадное удаление в модели (models.py)

**Изменения в модели City:**
- Добавлена связь `strategic_projects` с каскадным удалением
- Теперь при удалении объекта строительства автоматически удаляются все связанные проекты в стратегической карте

```python
strategic_projects = relationship("StrategicMapProject", back_populates="city", cascade="all, delete-orphan")
```

**Изменения в модели StrategicMapProject:**
- Обновлена связь с City для поддержки двусторонней связи

```python
city = relationship("City", back_populates="strategic_projects")
```

### 2. Улучшена функция синхронизации (strategic_map.py)

**Функция `/sync-from-cities` теперь:**
- ✓ Создает новые проекты для новых объектов строительства
- ✓ Обновляет названия существующих проектов
- ✓ **УДАЛЯЕТ проекты для удаленных объектов строительства** (новая функциональность)

**Возвращаемые данные:**
```json
{
  "status": "synced",
  "created": 0,      // Количество созданных проектов
  "updated": 0,      // Количество обновленных проектов
  "deleted": 0,      // Количество удаленных проектов
  "total": 3         // Всего объектов строительства
}
```

## Как это работает

### Автоматическое удаление при удалении города
1. Пользователь удаляет объект строительства через API
2. SQLAlchemy автоматически удаляет все связанные проекты в стратегической карте
3. Вместе с проектами удаляются все их вехи (milestones) благодаря cascade

### Синхронизация через кнопку
1. Пользователь нажимает кнопку "Синхронизировать с объектами строительства"
2. Система проверяет все проекты, привязанные к городам
3. Удаляет проекты, для которых больше нет соответствующих городов
4. Создает проекты для новых городов
5. Обновляет названия для существующих проектов

## Требуется перезапуск сервера

После внесения изменений необходимо перезапустить backend сервер:

```bash
# Остановите текущий сервер (Ctrl+C)
# Затем запустите заново:
uvicorn app.main:app --reload --port 8000
```

## Тестирование

1. Создайте новый объект строительства
2. Нажмите "Синхронизировать" в мастер-карте
3. Убедитесь, что создался новый проект
4. Удалите объект строительства
5. Проект должен автоматически удалиться из мастер-карты
