"""
Скрипт для импорта данных графиков строительства
Заполняет все вкладки: 
- Графики выдачи рабочей документации (document)
- HR графики (hr)
- Графики закупок (procurement)
- Графики строительства (construction)
"""

from datetime import datetime
from app.database import SessionLocal, engine
from app import models

# Create tables if not exist
models.Base.metadata.create_all(bind=engine)

def parse_date(date_str):
    """Парсинг даты в формате DD.MM.YYYY"""
    if not date_str or date_str.strip() == "":
        return None
    try:
        return datetime.strptime(date_str.strip(), "%d.%m.%Y")
    except ValueError:
        print(f"  [!] Ne udalos' razobrat' datu: '{date_str}'")
        return None

def get_or_create_city(db, city_name="Москва"):
    """Получить или создать город"""
    city = db.query(models.City).filter(models.City.name == city_name).first()
    if not city:
        city = models.City(name=city_name, description="Объект строительства")
        db.add(city)
        db.commit()
        db.refresh(city)
        print(f"[+] Sozdan gorod: {city_name}")
    return city

def get_or_create_stage(db, stage_name):
    """Получить или создать этап строительства"""
    if not stage_name or stage_name.strip() == "":
        return None
    
    stage = db.query(models.ConstructionStage).filter(
        models.ConstructionStage.name == stage_name.strip()
    ).first()
    
    if not stage:
        max_order = db.query(models.ConstructionStage).count()
        stage = models.ConstructionStage(
            name=stage_name.strip(),
            description="Импортирован автоматически",
            order_index=max_order,
            is_active=True
        )
        db.add(stage)
        db.commit()
        db.refresh(stage)
        print(f"  [+] Sozdan novyj etap: {stage_name}")
    
    return stage

def get_admin_user(db):
    """Получить пользователя admin для привязки записей"""
    admin = db.query(models.User).filter(models.User.username == "admin").first()
    if not admin:
        raise Exception("Пользователь admin не найден. Сначала выполните create_admin.py")
    return admin

# ====== Данные для графиков выдачи рабочей документации (document) ======
document_schedules_data = [
    # (этап_строительства, разделы, план_начало, план_окончание, факт_начало, факт_окончание)
    ("Благоустройство", "ГП – Генеральный план | Благоустройство", "20.09.2024", "20.09.2024", "", ""),
    ("Каменная кладка", "АР – Архитектурные решения | Каменная кладка", "21.06.2024", "21.06.2024", "05.08.2024", "05.08.2024"),
    ("Разработка котлована", "АС.0 – Архитектурно-строительные решения ниже отм. 0.000 | Разработка котлована", "21.06.2024", "21.06.2024", "04.07.2024", "04.07.2024"),
    ("Каменная кладка", "АС.1 – Архитектурно-строительные решения выше отм. 0.000 | Каменная кладка", "26.07.2024", "26.07.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 1 - 1 секция - Планы, разрез по зданию, ЖБ сборный | Каменная кладка", "27.06.2024", "27.06.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 2 - 2 секция | Каменная кладка", "01.07.2024", "01.07.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 3 - 3 секция | Каменная кладка", "03.07.2024", "03.07.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 4 - 4 секция | Каменная кладка", "09.07.2024", "09.07.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 5 - 5 секция | Каменная кладка", "12.07.2024", "12.07.2024", "31.07.2024", "31.07.2024"),
    ("Каменная кладка", "Этап 6 - Развертки вентиляционных каналов | Каменная кладка", "19.07.2024", "19.07.2024", "31.07.2024", "31.07.2024"),
    ("Устройство кровли", "Этап 7 - Кровля, парапеты, элементы КМ, крыльцо и т.п. | Устройство кровли", "19.09.2024", "19.09.2024", "31.07.2024", "31.07.2024"),
    ("Наружный высоковольтный кабель", "ЭС – Наружные сети электроснабжения | Наружный высоковольтный кабель", "19.09.2024", "19.09.2024", "", ""),
    ("Электромонтажные работы", "ЭOМ – Электроосвещение и силовое электрооборудование | Электромонтажные работы", "19.09.2024", "19.09.2024", "25.02.2025", "25.02.2025"),
    ("Сети наружного освещения", "ЭН – Наружное электроосвещение | Сети наружного освещения", "19.09.2024", "19.09.2024", "", ""),
    ("Монтаж ОВ и ВК", "ВК – Внутренние системы водоснабжения и канализации | Монтаж ОВ и ВК", "19.09.2024", "19.09.2024", "19.03.2025", "19.03.2025"),
    ("Наружный водопровод", "НВК – Наружные сети водоснабжения и канализации | Наружный водопровод", "19.09.2024", "19.09.2024", "24.09.2024", "24.09.2024"),
    ("Монтаж ИТП", "ИТП – Индивидуальный тепловой пункт. | Монтаж ИТП", "28.06.2024", "28.06.2024", "26.02.2025", "26.02.2025"),
    ("Теплотрасса от котельной к ж/д", "ТС – Тепловые сети | Теплотрасса от котельной к ж/д", "04.10.2024", "04.10.2024", "", ""),
    ("Монтаж ОВ и ВК", "OВ – Oтопление, вентиляция и кондиционирование | Монтаж ОВ и ВК", "20.09.2024", "20.09.2024", "26.02.2025", "26.02.2025"),
    ("Домофон, интернет, слаботочные системы, пожаротушение", "СС – Сети связи | Домофон, интернет, слаботочные системы, пожаротушение", "04.10.2024", "04.10.2024", "17.12.2024", "17.12.2024"),
    ("Пожарная сигнализация", "ПС – Пожарная сигнализация | Пожарная сигнализация", "04.10.2024", "04.10.2024", "17.12.2024", "17.12.2024"),
    ("Наружный газопровод", "ГСН - Наружные газопроводы | Наружный газопровод", "15.06.2024", "15.06.2024", "02.04.2025", "02.04.2025"),
]

# ====== Данные для HR графиков ======
hr_schedules_data = [
    # (этап_строительства, вакансия, кол_план, кол_факт, план_начало, план_окончание, факт_начало, факт_окончание)
    ("Подготовительные работы", "Снос зеленых насаждений, устройство забора, временного водопровода, электроэнергия, временной дороги, ППР", None, None, "10.06.2024", "31.07.2024", "", "15.05.2024"),
    ("Подготовительные работы", "Разнорабочий, 4 вакансии", 4, 4, "21.04.2024", "20.06.2024", "21.04.2024", "20.06.2024"),
    ("Подготовительные работы", "Стропальщик, 2 вакансии", 2, 2, "02.05.2024", "01.07.2024", "02.05.2024", "01.07.2024"),
    ("Подготовительные работы", "Электрик", 1, 1, "03.07.2024", "01.09.2024", "08.07.2024", "01.09.2024"),
    ("Подготовительные работы", "Стропальщик, 2 вакансии", 1, 1, "02.06.2024", "01.08.2024", "02.06.2024", "01.08.2024"),
    ("Разработка котлована", "Замещение глиняных линз песком с уплотнением", None, None, "03.07.2024", "20.07.2024", "03.07.2024", "07.07.2024"),
    ("Разработка котлована", "Помощник бухгалтера-кладовщика, 0,5", 1, 1, "16.05.2024", "15.07.2024", "01.07.2024", "16.07.2024"),
    ("Разработка котлована", "Производитель работ", 1, 1, "02.06.2024", "01.08.2024", "08.07.2024", "01.09.2024"),
    ("Разработка котлована", "Администратор", 1, 1, "24.06.2025", "10.08.2025", "24.06.2025", "23.07.2025"),
]

# ====== Данные для графиков закупок (procurement) ======
procurement_schedules_data = [
    # (этап_строительства, наименование_работ, служба, ответственный, контрагент, план_начало, план_окончание, факт_начало, факт_окончание)
    ("Подготовительные работы", "Снос зеленых насаждений, устройство забора, временного водопровода, электроэнергия, временной дороги, ППР", "Строительство", "", "", "10.06.2024", "31.07.2024", "10.05.2024", "15.05.2024"),
    ("Подготовительные работы", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "20.05.2024", "05.06.2024", "", ""),
    ("Подготовительные работы", "предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "10.05.2024", "15.05.2024", "", ""),
    ("Разработка котлована", "Земляные работы ", "Строительство", "", "", "20.06.2024", "20.07.2024", "12.06.2024", "02.07.2024"),
    ("Разработка котлована", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "05.06.2024", "12.06.2024", "", ""),
    ("Разработка котлована", "предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "15.05.2024", "25.05.2024", "", ""),
    ("Разработка котлована", "Замещение глиняных линз песком с уплотнением", "Строительство", "", "", "03.07.2024", "20.07.2024", "03.07.2024", "07.07.2024"),
    ("Разработка котлована", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Семенов Е.", "", "20.06.2024", "27.06.2024", "", ""),
    ("Разработка котлована", "предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.06.2024", "05.06.2024", "", ""),
    ("Перебазировка и монтаж башенных кранов", "3 башенных крана", "Строительство", "", "", "10.07.2024", "30.08.2024", "10.07.2024", "26.08.2024"),
    ("Перебазировка и монтаж башенных кранов", "Предоставление каменщиков на все 5 секции", "Закупки_ОС", "Семенов Е.", "", "10.07.2024", "20.07.2024", "", ""),
    ("Перебазировка и монтаж башенных кранов", "предоставление объемов лицевого кирпича", "Закупки_ПТО", "Макарова Н.", "", "05.06.2024", "15.06.2024", "", ""),
    ("Каменная кладка", "Каменная кладка 5 секций", "Строительство", "", "", "20.08.2024", "30.05.2025", "12.09.2024", "01.10.2025"),
    ("Каменная кладка", "Проведение тендера на кровельные работы", "Закупки_ОС", "Борисенко Ю.", "", "15.04.2025", "25.04.2025", "", ""),
    ("Каменная кладка", "Предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "10.04.2025", "", ""),
    ("Каменная кладка", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "10.04.2025", "20.04.2025", "", ""),
    ("Электромонтажные работы", "Подготовительные работы", "Строительство", "", "", "20.01.2025", "10.03.2025", "20.01.2025", "10.03.2025"),
    ("Электромонтажные работы", "Проведение тендера на кровельные работы", "Закупки_ОС", "Борисенко Ю.", "", "15.05.2025", "20.05.2025", "", ""),
    ("Электромонтажные работы", "Предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "10.04.2025", "", ""),
    ("Электромонтажные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "10.04.2025", "20.04.2025", "", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", "Строительство", "", "", "20.01.2025", "20.04.2025", "20.01.2025", "20.04.2025"),
    ("Монтаж ОВ и ВК", "Проведение тендера на фасадные работы", "Закупки_ОС", "Борисенко Ю.", "", "15.05.2025", "30.05.2025", "", ""),
    ("Монтаж ОВ и ВК", "Предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.05.2025", "07.05.2025", "", ""),
    ("Монтаж ОВ и ВК", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "01.06.2025", "10.06.2025", "", ""),
    ("Монтаж оконных конструкций", "Монтаж оконных конструкций", "Строительство", "", "", "01.03.2025", "20.06.2025", "", ""),
    ("Монтаж оконных конструкций", "Выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "15.05.2025", "01.06.2025", "", ""),
    ("Монтаж оконных конструкций", "Предоставление объемов для проведения тендера", "Закупки_ПТО", "Макарова Н.", "", "05.05.2025", "10.05.2025", "", ""),
    ("Монтаж оконных конструкций", "закупка материалов", "Закупки_ОС", "Петрова Е.", "", "05.05.2025", "15.05.2025", "", ""),
    ("Электромонтажные работы", "Электромонтажные работы", "Строительство", "", "", "20.06.2025", "30.06.2025", "", ""),
    ("Электромонтажные работы", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.06.2025", "10.06.2025", "", ""),
    ("Электромонтажные работы", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "", "", "", ""),
    ("Электромонтажные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "", "", "", ""),
    ("Монтаж металлических ограждений по фасаду", "Монтаж металлических ограждений по фасаду", "Строительство", "", "", "10.04.2025", "20.06.2025", "", ""),
    ("Монтаж металлических ограждений по фасаду", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.12.2024", "10.12.2024", "", ""),
    ("Монтаж металлических ограждений по фасаду", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "10.12.2024", "20.12.2024", "", ""),
    ("Монтаж металлических ограждений по фасаду", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "10.12.2024", "15.12.2024", "", ""),
    ("Штукатурные работы", "Штукатурные работы 1-ая орг-ция 1,2,3 с.", "Строительство", "", "", "10.04.2025", "10.07.2025", "", ""),
    ("Штукатурные работы", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.12.2024", "10.12.2024", "", ""),
    ("Штукатурные работы", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "10.12.2024", "20.12.2024", "", ""),
    ("Штукатурные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "10.12.2024", "15.12.2024", "", ""),
    ("Штукатурные работы", "Штукатурные работы 2-ая орг-ция 4,5с.", "Строительство", "", "", "10.04.2025", "10.07.2025", "", ""),
    ("Штукатурные работы", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.12.2024", "10.12.2024", "", ""),
    ("Штукатурные работы", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "10.12.2024", "20.12.2024", "", ""),
    ("Штукатурные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "10.12.2024", "15.12.2024", "", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", "Строительство", "", "", "10.07.2025", "20.07.2025", "", ""),
    ("Монтаж ОВ и ВК", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Бабаян А.", "", "15.01.2025", "15.02.2025", "", ""),
    ("Монтаж ОВ и ВК", "Предоставление объемов для проведения тендера ", "Закупки_ПТО", "Макарова Н.", "", "10.01.2025", "15.01.2025", "", ""),
    ("Монтаж насосной, ИТП, электрощитовой", "Монтаж насосной, ИТП, электрощитовой", "Строительство", "", "", "20.05.2025", "10.07.2025", "", ""),
    ("Монтаж насосной, ИТП, электрощитовой", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.02.2025", "20.02.2025", "", ""),
    ("Монтаж насосной, ИТП, электрощитовой", "Предоставление объемов для проведения тендера ", "Закупки_ПТО", "Макарова Н.", "", "20.01.2025", "30.01.2025", "", ""),
    ("Устройство стяжки пола", "Устройство стяжки пола 1-ая орг-ция 1,2,3 с.", "Строительство", "", "", "20.05.2025", "10.08.2025", "", ""),
    ("Устройство стяжки пола", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.02.2025", "15.02.2025", "", ""),
    ("Устройство стяжки пола", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "15.01.2025", "30.01.2025", "", ""),
    ("Устройство стяжки пола", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "01.03.2025", "15.03.2025", "", ""),
    ("Устройство стяжки пола", "Устройство стяжки пола 2-ая орг-ция 4,5с.", "Строительство", "", "", "20.05.2025", "10.08.2025", "", ""),
    ("Устройство стяжки пола", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.02.2025", "15.02.2025", "", ""),
    ("Устройство стяжки пола", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "15.01.2025", "30.01.2025", "", ""),
    ("Устройство стяжки пола", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "01.03.2025", "15.03.2025", "", ""),
    ("Монтаж отдельно стоящей котельной", "Монтаж газовой котельной", "Строительство", "", "", "20.05.2025", "10.07.2025", "", ""),
    ("Монтаж отдельно стоящей котельной", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.03.2025", "15.03.2025", "", ""),
    ("Монтаж отдельно стоящей котельной", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "15.03.2025", "30.03.2025", "", ""),
    ("Монтаж отдельно стоящей котельной", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "30.03.2025", "10.04.2025", "", ""),
    ("Устройство кровли", "Устройство кровли 2-ая орг-ция 4,5с.", "Строительство", "", "", "01.06.2025", "10.07.2025", "", ""),
    ("Устройство кровли", "Согласование ТЗ от ПТО", "Закупки_ПТО", "Макарова Н.", "", "01.02.2025", "10.02.2025", "", ""),
    ("Устройство кровли", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "10.02.2025", "20.05.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Сети водопровода и канализации", "Строительство", "", "", "01.06.2025", "30.06.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.04.2025", "15.04.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "05.04.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "05.04.2025", "15.04.2025", "", ""),
    ("Наружный водопровод", "Наружный водопровод", "Строительство", "", "", "10.06.2025", "10.07.2025", "", ""),
    ("Наружный водопровод", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.04.2025", "15.04.2025", "", ""),
    ("Наружный водопровод", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "05.04.2025", "", ""),
    ("Наружный водопровод", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "05.04.2025", "15.04.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Теплосети", "Строительство", "", "", "10.06.2025", "10.07.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Согласование ТУ ГИП-ом проекта (Солдатов А.)", "", "", "", "10.01.2025", "30.01.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Подключение местным подрядчиком в рамках ТУ", "", "", "", "10.06.2025", "10.07.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Сети ливневой канализации", "Строительство", "", "", "10.06.2025", "10.07.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Согласование ТУ ГИП-ом проекта (Солдатов О.)", "", "", "", "10.01.2025", "30.01.2025", "", ""),
    ("Внутриплощадочные инженерные сети", "Подключение местным подрядчиком в рамках ТУ", "", "", "", "10.05.2025", "30.06.2025", "", ""),
    ("Внутриплощадочные электрические сети", "Внутриплощадочные электрические сети 0,4кВ", "Строительство", "", "", "10.06.2025", "30.06.2025", "", ""),
    ("Внутриплощадочные электрические сети", "Предоставлени ТЗ на газовую кательную Солдатов О.)", "", "", "", "01.12.2024", "20.12.2024", "", ""),
    ("Внутриплощадочные электрические сети", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Петрова Е.", "", "10.01.2025", "25.01.2025", "", ""),
    ("Монтаж лифтового оборудования", "Монтаж лифтового оборудования", "Строительство", "", "", "10.06.2025", "10.09.2025", "", ""),
    ("Монтаж лифтового оборудования", "Предоставление проекта для провдеения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "20.04.2025", "", ""),
    ("Монтаж лифтового оборудования", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "20.04.2025", "10.05.2025", "", ""),
    ("Демонтаж и перебазировка башенных кранов", "Демонтаж и перебазировка башенных кранов 3 башенных крана", "Строительство", "", "", "20.06.2025", "10.08.2025", "", ""),
    ("Демонтаж и перебазировка башенных кранов", "Предоставление проекта для провдеения тендера", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "20.04.2025", "", ""),
    ("Демонтаж и перебазировка башенных кранов", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "20.04.2025", "10.05.2025", "", ""),
    ("Электромонтажные работы", "Электромонтажные работы", "Строительство", "", "", "10.08.2025", "30.11.2025", "", ""),
    ("Электромонтажные работы", "Предоставление проекта для провдеения тендера", "Закупки_ПТО", "Макарова Н.", "", "", "", "", ""),
    ("Электромонтажные работы", "Проведение тендера и выбор подрядчика", "Закупки_ОС", "Борисенко Ю.", "", "", "", "", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", "Строительство", "", "", "20.08.2025", "20.11.2025", "", ""),
    ("Монтаж ОВ и ВК", "Выбор лифвтового оборудования и подрядчика ", "Закупки_ОС", "Борисенко Ю.", "", "01.02.2025", "15.02.2025", "", ""),
    ("Отделочные работы", "Отделочные работы 1-ая орг-ция 1,2,3 с.", "Строительство", "", "", "01.08.2025", "20.11.2025", "", ""),
    ("Отделочные работы", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "10.07.2025", "15.07.2025", "", ""),
    ("Отделочные работы", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.07.2025", "10.07.2025", "", ""),
    ("Отделочные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "10.07.2025", "15.07.2025", "", ""),
    ("Отделочные работы", "Отделочные работы 2-ая орг-ция 4,5с.", "Строительство", "", "", "01.08.2025", "20.11.2025", "", ""),
    ("Отделочные работы", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "10.07.2025", "15.07.2025", "", ""),
    ("Отделочные работы", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.07.2025", "10.07.2025", "", ""),
    ("Отделочные работы", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "10.07.2025", "15.07.2025", "", ""),
    ("Благоустройство", "Благоустройство", "Строительство", "", "", "01.08.2025", "20.09.2025", "", ""),
    ("Благоустройство", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.07.2025", "20.07.2025", "", ""),
    ("Благоустройство", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.06.2025", "05.06.2025", "", ""),
    ("Благоустройство", "Закупка материалов для проведения работ", "Закупки_ОС", "Бабаян А.", "", "05.06.2025", "12.06.2025", "", ""),
    ("Сети наружного освещения", "Сети наружного освещения", "Строительство", "", "", "10.08.2025", "30.08.2025", "", ""),
    ("Сети наружного освещения", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.09.2025", "15.09.2025", "", ""),
    ("Монтаж лестничных ограждений", "Монтаж лестничных ограждений", "Строительство", "", "", "20.08.2025", "20.09.2025", "", ""),
    ("Монтаж лестничных ограждений", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.09.2025", "10.09.2025", "", ""),
    ("Пуск тепла", "Пуск тепла", "Строительство", "", "", "10.09.2025", "20.09.2025", "", ""),
    ("Пуск тепла", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.07.2025", "10.07.2025", "", ""),
    ("Пуск тепла", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "20.06.2025", "30.06.2025", "", ""),
    ("Пуск тепла", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "30.06.2025", "10.07.2025", "", ""),
    ("Озеленение", "Озеленение", "Строительство", "", "", "10.09.2025", "30.09.2025", "", ""),
    ("Озеленение", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "10.04.2025", "30.04.2025", "", ""),
    ("Озеленение", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.04.2025", "10.04.2025", "", ""),
    ("Озеленение", "Закупка материалов для проведения работ", "Закупки_ОС", "Петрова Е.", "", "01.06.2025", "20.06.2025", "", ""),
    ("Ограждение территории", "Ограждение территории", "Строительство", "", "", "20.09.2025", "10.10.2025", "", ""),
    ("Ограждение территории", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.07.2025", "15.07.2025", "", ""),
    ("Ограждение территории", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_Продукт", "Аверин А.", "", "01.06.2025", "10.06.2025", "", ""),
    ("Домофон, интернет, слаботочные системы, пожаротушение", "Домофон, интернет, слаботочные системы, пожаротушение", "Строительство", "", "", "01.11.2025", "30.11.2025", "", ""),
    ("Домофон, интернет, слаботочные системы, пожаротушение", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "10.07.2025", "20.07.2025", "", ""),
    ("Домофон, интернет, слаботочные системы, пожаротушение", "Предоставление объемов для проведения тендера и закупки материалов", "Закупки_ПТО", "Макарова Н.", "", "01.07.2025", "10.07.2025", "", ""),
    ("Пожарная сигнализация", "Пожарная сигнализация", "Строительство", "", "", "01.11.2025", "30.11.2025", "", ""),
    ("Пожарная сигнализация", "Выбор подрядчика для проведения работ", "Закупки_ОС", "Борисенко Ю.", "", "01.10.2025", "15.10.2025", "", ""),
    ("Пожарная сигнализация", "ПРедоставление ТЗ для проведения работ", "Закупки_Продукт", "Аверин А.", "", "15.09.2025", "30.09.2025", "", ""),
]

# ====== Данные для графиков строительства (construction) ======
construction_schedules_data = [
    # (этап_строительства, наименование_работ, кол_рабочих, план_начало, план_окончание, факт_начало, факт_окончание, выдача_док)
    ("Подготовительные работы", "Снос зеленых насаждений, устройство забора, временного водопровода, электроэнергия, временной дороги, ППР", None, "10.06.2024", "31.07.2024", "10.05.2024", "15.05.2024", ""),
    ("Разработка котлована", "Земляные работы ", None, "20.06.2024", "20.07.2024", "12.06.2024", "02.07.2024", "30.06.2024"),
    ("Разработка котлована", "Замещение глиняных линз песком с уплотнением", None, "03.07.2024", "20.07.2024", "03.07.2024", "07.07.2024", ""),
    ("Фундамент", "Фундамент", None, "10.07.2024", "20.09.2024", "07.07.2024", "09.09.2024", ""),
    ("Перебазировка и монтаж башенных кранов", "3 башенных крана", None, "10.07.2024", "30.08.2024", "10.07.2024", "26.08.2024", ""),
    ("Каменная кладка", "Каменная кладка 5 секций", None, "20.08.2024", "30.05.2025", "12.09.2024", "01.10.2025", "30.06.2024"),
    ("Электромонтажные работы", "Подготовительные работы", None, "20.01.2025", "10.03.2025", "20.01.2025", "10.03.2025", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", None, "20.01.2025", "20.04.2025", "20.01.2025", "20.04.2025", ""),
    ("Монтаж оконных конструкций", "Монтаж оконных конструкций", None, "01.03.2025", "20.06.2025", "", "", ""),
    ("Электромонтажные работы", "Электромонтажные работы", None, "20.06.2025", "30.06.2025", "", "", ""),
    ("Монтаж металлических ограждений по фасаду", "Монтаж металлических ограждений по фасаду", None, "10.04.2025", "20.06.2025", "", "", ""),
    ("Штукатурные работы", "Штукатурные работы 1-ая орг-ция 1,2,3 с.", None, "10.04.2025", "10.07.2025", "", "", ""),
    ("Штукатурные работы", "Штукатурные работы 2-ая орг-ция 4,5с.", None, "10.04.2025", "10.07.2025", "", "", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", None, "10.07.2025", "20.07.2025", "", "", ""),
    ("Монтаж насосной, ИТП, электрощитовой", "Монтаж насосной, ИТП, электрощитовой", None, "20.05.2025", "10.07.2025", "", "", ""),
    ("Устройство стяжки пола", "Устройство стяжки пола 1-ая орг-ция 1,2,3 с.", None, "20.05.2025", "10.08.2025", "", "", ""),
    ("Устройство стяжки пола", "Устройство стяжки пола 2-ая орг-ция 4,5с.", None, "20.05.2025", "10.08.2025", "", "", ""),
    ("Монтаж ТП на объект", "Монтаж ТП на объект", None, "20.05.2025", "30.06.2025", "20.01.2025", "30.04.2025", ""),
    ("Монтаж отдельно стоящей котельной", "Монтаж газовой котельной", None, "20.05.2025", "10.07.2025", "", "", ""),
    ("Устройство кровли", "Устройство кровли 1-ая орг-ция 1,2,3 с.", None, "01.06.2025", "10.07.2025", "", "", ""),
    ("Устройство кровли", "Устройство кровли 2-ая орг-ция 4,5с.", None, "01.06.2025", "10.07.2025", "", "", ""),
    ("Внутриплощадочные инженерные сети", "Сети водопровода и канализации", None, "01.06.2025", "30.06.2025", "", "", ""),
    ("Наружный водопровод", "Наружный водопровод", None, "10.06.2025", "10.07.2025", "", "", ""),
    ("Наружный газопровод", "Газопровод высокого давления", None, "10.06.2025", "10.07.2025", "", "", ""),
    ("Наружный высоковольтный кабель", "Наружный высоковольтный кабель 10кВ", None, "10.06.2025", "10.07.2025", "", "", ""),
    ("Внутриплощадочные инженерные сети", "Теплосети", None, "10.06.2025", "10.07.2025", "", "", ""),
    ("Внутриплощадочные инженерные сети", "Сети ливневой канализации", None, "10.06.2025", "10.07.2025", "", "", ""),
    ("Внутриплощадочные электрические сети", "Внутриплощадочные электрические сети 0,4кВ", None, "10.06.2025", "30.06.2025", "", "", ""),
    ("Монтаж лифтового оборудования", "Монтаж лифтового оборудования", None, "10.06.2025", "10.09.2025", "", "", ""),
    ("Демонтаж и перебазировка башенных кранов", "Демонтаж и перебазировка башенных кранов 3 башенных крана", None, "20.06.2025", "10.08.2025", "", "", ""),
    ("Электромонтажные работы", "Электромонтажные работы", None, "10.08.2025", "30.11.2025", "", "", ""),
    ("Наружная отделка фасада", "Наружная отделка фасада", None, "01.07.2025", "10.10.2025", "", "", ""),
    ("Утепление вентшахт, козырьки, переходные лестницы", "Утепление вентшахт, козырьки, переходные лестницы 1-ая орг-ция 1,2,3 с.", None, "10.07.2025", "20.08.2025", "", "", ""),
    ("Утепление вентшахт, козырьки, переходные лестницы", "Утепление вентшахт, козырьки, переходные лестницы 2-ая орг-ция 4,5с.", None, "10.07.2025", "20.08.2025", "", "", ""),
    ("Монтаж ОВ и ВК", "Монтаж ОВ и ВК", None, "20.08.2025", "20.11.2025", "", "", ""),
    ("Отделочные работы", "Отделочные работы 1-ая орг-ция 1,2,3 с.", None, "01.08.2025", "20.11.2025", "", "", ""),
    ("Отделочные работы", "Отделочные работы 2-ая орг-ция 4,5с.", None, "01.08.2025", "20.11.2025", "", "", ""),
    ("Монтаж дверей", "Монтаж дверей", None, "01.08.2025", "30.09.2025", "", "", ""),
    ("Благоустройство", "Благоустройство", None, "01.08.2025", "20.09.2025", "", "", ""),
    ("Сети наружного освещения", "Сети наружного освещения", None, "10.08.2025", "30.08.2025", "", "", ""),
    ("Монтаж лестничных ограждений", "Монтаж лестничных ограждений", None, "20.08.2025", "20.09.2025", "", "", ""),
    ("Пуск тепла", "Пуск тепла", None, "10.09.2025", "20.09.2025", "", "", ""),
    ("Озеленение", "Озеленение", None, "10.09.2025", "30.09.2025", "", "", ""),
    ("Ограждение территории", "Ограждение территории", None, "20.09.2025", "10.10.2025", "", "", ""),
    ("Домофон, интернет, слаботочные системы, пожаротушение", "Домофон, интернет, слаботочные системы, пожаротушение", None, "01.11.2025", "30.11.2025", "", "", ""),
    ("Пожарная сигнализация", "Пожарная сигнализация", None, "01.11.2025", "30.11.2025", "", "", ""),
    ("Навигация", "Навигация", None, "10.11.2025", "10.12.2025", "", "", ""),
    ("Получение ЗОС и РНВ", "Получение ЗОС и РНВ", None, "10.11.2025", "20.12.2025", "", "", ""),
    ("Обеспечение пожарной безопасности", "Подготовка рва и других обязательных  работ для обеспечения пожарной безопасности", None, "", "", "", "", ""),
]


def import_document_schedules(db, city, admin):
    """Импорт графиков выдачи документации"""
    print("\n" + "="*60)
    print("ИМПОРТ ГРАФИКОВ ВЫДАЧИ РАБОЧЕЙ ДОКУМЕНТАЦИИ")
    print("="*60)
    
    created = 0
    for item in document_schedules_data:
        stage_name, sections, plan_start, plan_end, fact_start, fact_end = item
        
        plan_start_date = parse_date(plan_start)
        plan_end_date = parse_date(plan_end)
        
        # Пропускаем записи без плановых дат
        if not plan_start_date or not plan_end_date:
            print(f"  [!] Propushcheno (net planovykh dat): {sections[:50]}...")
            continue
        
        stage = get_or_create_stage(db, stage_name)
        
        schedule = models.Schedule(
            schedule_type="document",
            city_id=city.id,
            creator_id=admin.id,
            construction_stage_id=stage.id if stage else None,
            construction_stage=stage_name,
            sections=sections,
            planned_start_date=plan_start_date,
            planned_end_date=plan_end_date,
            actual_start_date=parse_date(fact_start),
            actual_end_date=parse_date(fact_end)
        )
        db.add(schedule)
        created += 1
    
    db.commit()
    print(f"\n[+] Sozdano zapisej dokumentacii: {created}")
    return created


def import_hr_schedules(db, city, admin):
    """Импорт HR графиков"""
    print("\n" + "="*60)
    print("ИМПОРТ HR ГРАФИКОВ")
    print("="*60)
    
    created = 0
    for item in hr_schedules_data:
        stage_name, vacancy, qty_plan, qty_fact, plan_start, plan_end, fact_start, fact_end = item
        
        plan_start_date = parse_date(plan_start)
        plan_end_date = parse_date(plan_end)
        
        if not plan_start_date or not plan_end_date:
            print(f"  [!] Propushcheno (net planovykh dat): {vacancy[:50] if vacancy else 'bez nazvaniya'}...")
            continue
        
        stage = get_or_create_stage(db, stage_name)
        
        schedule = models.Schedule(
            schedule_type="hr",
            city_id=city.id,
            creator_id=admin.id,
            construction_stage_id=stage.id if stage else None,
            construction_stage=stage_name,
            vacancy=vacancy,
            quantity_plan=qty_plan,
            quantity_fact=qty_fact,
            planned_start_date=plan_start_date,
            planned_end_date=plan_end_date,
            actual_start_date=parse_date(fact_start),
            actual_end_date=parse_date(fact_end)
        )
        db.add(schedule)
        created += 1
    
    db.commit()
    print(f"\n[+] Sozdano HR zapisej: {created}")
    return created


def import_procurement_schedules(db, city, admin):
    """Импорт графиков закупок"""
    print("\n" + "="*60)
    print("ИМПОРТ ГРАФИКОВ ЗАКУПОК")
    print("="*60)
    
    created = 0
    skipped = 0
    for item in procurement_schedules_data:
        stage_name, work_name, service, responsible, contractor, plan_start, plan_end, fact_start, fact_end = item
        
        plan_start_date = parse_date(plan_start)
        plan_end_date = parse_date(plan_end)
        
        if not plan_start_date or not plan_end_date:
            skipped += 1
            continue
        
        stage = get_or_create_stage(db, stage_name)
        
        schedule = models.Schedule(
            schedule_type="procurement",
            city_id=city.id,
            creator_id=admin.id,
            construction_stage_id=stage.id if stage else None,
            construction_stage=stage_name,
            work_name=work_name,
            service=service if service else None,
            responsible_employee=responsible if responsible else None,
            contractor=contractor if contractor else None,
            planned_start_date=plan_start_date,
            planned_end_date=plan_end_date,
            actual_start_date=parse_date(fact_start),
            actual_end_date=parse_date(fact_end)
        )
        db.add(schedule)
        created += 1
    
    db.commit()
    print(f"\n[+] Sozdano zapisej zakupok: {created}")
    if skipped > 0:
        print(f"  Пропущено (нет плановых дат): {skipped}")
    return created


def import_construction_schedules(db, city, admin):
    """Импорт графиков строительства"""
    print("\n" + "="*60)
    print("ИМПОРТ ГРАФИКОВ СТРОИТЕЛЬСТВА")
    print("="*60)
    
    created = 0
    skipped = 0
    for item in construction_schedules_data:
        stage_name, work_name, workers, plan_start, plan_end, fact_start, fact_end, doc_issue = item
        
        plan_start_date = parse_date(plan_start)
        plan_end_date = parse_date(plan_end)
        
        if not plan_start_date or not plan_end_date:
            skipped += 1
            continue
        
        stage = get_or_create_stage(db, stage_name)
        
        schedule = models.Schedule(
            schedule_type="construction",
            city_id=city.id,
            creator_id=admin.id,
            construction_stage_id=stage.id if stage else None,
            construction_stage=stage_name,
            work_name=work_name,
            workers_count=workers,
            planned_start_date=plan_start_date,
            planned_end_date=plan_end_date,
            actual_start_date=parse_date(fact_start),
            actual_end_date=parse_date(fact_end)
        )
        db.add(schedule)
        created += 1
    
    db.commit()
    print(f"\n[+] Sozdano zapisej stroitelstva: {created}")
    if skipped > 0:
        print(f"  Пропущено (нет плановых дат): {skipped}")
    return created


def main():
    print("="*60)
    print("ИМПОРТ ДАННЫХ ГРАФИКОВ СТРОИТЕЛЬСТВА")
    print("="*60)
    
    db = SessionLocal()
    
    try:
        # Получаем или создаем город (можно изменить название)
        city = get_or_create_city(db, "Москва")
        print(f"[+] Ispolzuetsya gorod: {city.name} (ID: {city.id})")
        
        # Получаем пользователя admin
        admin = get_admin_user(db)
        print(f"[+] Ispolzuetsya polzovatel: {admin.username}")
        
        # Импортируем данные
        doc_count = import_document_schedules(db, city, admin)
        hr_count = import_hr_schedules(db, city, admin)
        proc_count = import_procurement_schedules(db, city, admin)
        constr_count = import_construction_schedules(db, city, admin)
        
        # Итоги
        total = doc_count + hr_count + proc_count + constr_count
        
        print("\n" + "="*60)
        print("ИТОГИ ИМПОРТА")
        print("="*60)
        print(f"Графики документации:  {doc_count}")
        print(f"HR графики:            {hr_count}")
        print(f"Графики закупок:       {proc_count}")
        print(f"Графики строительства: {constr_count}")
        print(f"-" * 30)
        print(f"ВСЕГО:                 {total}")
        print("="*60)
        print("[OK] Import uspeshno zavershen!")
        
    except Exception as e:
        print(f"\n[X] Oshibka pri importe: {e}")
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    main()
